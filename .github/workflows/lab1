# This is a basic workflow to help you get started with Actions

name: CI Pipeline

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  push:
    branches: [ "main,master,develop" ]
  pull_request:
    branches: [ "main,master,develop" ]
permissions:
  contents:write
  pages:write
  id-token:write


  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  singlejoba
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
      - uses: actions/setup-node@v4
        with:
          node-version:'20'
            cache:'npm'
            cache-dependency-path:frontend/package-lock.json
  
        - name: Restore frontend dependencies
            working-directory: ./frontend
            run: npm ci
            continue-on-error: true

        - name: Run frontend tests
            working-directory: ./frontend
            run: npm run test:allure -- --run
            continue-on-error: true
            env:
              ALLURE_RESULTS_DIR: allure-results

        - name: Restore .NET dependencies
          working-directory: ./backend
          run: dotnet restore

        - name: Run backend tests with Allure
          working-directory: ./backend
          run: |
          mkdir -p allure-results
          export ALLURE_RESULTS_DIR=${{ github.workspace }}/backend/allure-results
          dotnet test Tests/Tests.csproj
          continue-on-error: true

        - name: Download Allure CLI
          run: |
            wget -q https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-
        2.24.1.tgz
          tar -zxvf allure-2.24.1.tgz
          sudo mv allure-2.24.1 /opt/allure
          sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure

- name: Collect all Allure results
  run: |
    mkdir -p allure-results
    if [ -d "frontend/allure-results" ]; then
    cp -r frontend/allure-results/* allure-results/ || true
    fi
    find backend -type d -name "allure-results" -not -path "*/node_modules/*" | while read dir;
    do
      if [ -d "$dir" ] && [ "$(ls -A $dir 2>/dev/null)" ]; then
        cp -r "$dir"/* allure-results/ || true
      fi
    done

      # Runs a set of commands using the runners shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.
